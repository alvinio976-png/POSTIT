<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>POSTIT — Tracker de publications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='512' height='512' fill='%23000'/><text x='50%' y='56%' font-size='260' text-anchor='middle' fill='%23fff' font-family='Arial'>P</text></svg>">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --card: rgba(15,15,20,0.55);
      --stroke: rgba(255,255,255,0.08);
      --txt: #f4f6fb;
      --muted:#aab3c0;
      --green:#19e28a; --orange:#ffb020; --red:#ff4d6d;
      --radius:20px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Roboto,Arial,sans-serif;background:#05060a;}

    /* BACKGROUND — ne capte pas les touches (fix iOS) */
    #bgWrap{position:fixed;inset:0;z-index:-2;overflow:hidden;pointer-events:none;}
    #bgVideo,#bgImage{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(0.55) saturate(1.2);}
    #glass{position:fixed;inset:0;background:
      radial-gradient(1200px 800px at 100% 0%, rgba(124,243,255,0.15), transparent 60%),
      linear-gradient(to bottom, rgba(0,0,0,0.50), rgba(0,0,0,0.70));
      backdrop-filter: blur(12px); z-index:-1; pointer-events:none;
    }

    header{position:sticky;top:0;z-index:5;padding:max(12px,env(safe-area-inset-top)) 14px 10px;
      display:flex;align-items:center;gap:10px;
      background:linear-gradient(to bottom, rgba(5,6,10,0.8), rgba(5,6,10,0));
      border-bottom:1px solid var(--stroke);backdrop-filter: blur(8px);
    }
    .brand{font-weight:800;letter-spacing:.5px;font-size:20px;}
    .pill{margin-left:auto;display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--card)}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--green)}
    .pill.red .dot{background:var(--red)} .pill.orange .dot{background:var(--orange)}

    main{position:relative;z-index:2;padding:16px;padding-bottom:calc(24px + env(safe-area-inset-bottom));
      display:grid;gap:14px;max-width:760px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 10px;font-size:16px;font-weight:700}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input,select,button{
      width:100%;padding:14px 12px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);color:var(--txt);font-size:15px;outline:none;
    }
    button{font-weight:700;letter-spacing:.3px;background:linear-gradient(135deg,#00e1ff33,#00ffa033);border-color:#00e1ff55}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border-color:var(--stroke)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    canvas{width:100%;height:260px;display:block}
    .mini{font-size:12px;color:var(--muted)}
    .insight{display:flex;justify-content:space-between;gap:8px;padding:10px 0;border-top:1px dashed var(--stroke)}
    .insight:first-child{border-top:0}

    /* Historique */
    .item{display:grid;gap:8px;padding:10px;border:1px solid var(--stroke);border-radius:14px;background:rgba(255,255,255,.04)}
    .item-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .meta{font-size:14px}
    .actions{display:flex;gap:8px}
    .edit{display:none;gap:8px}
    .edit .two{grid-template-columns:1fr 1fr}

    /* Giphy grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--stroke);aspect-ratio:1/1;background:rgba(255,255,255,.06);cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    @media(min-width:720px){ canvas{height:220px} }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
  </style>
</head>
<body>
  <div id="bgWrap">
    <video id="bgVideo" autoplay muted playsinline loop></video>
    <img id="bgImage" alt="" style="display:none"/>
  </div>
  <div id="glass"></div>

  <header>
    <div class="brand">POSTIT</div>
    <div id="statusPill" class="pill"><span class="dot"></span><span id="pillText">On track</span></div>
  </header>

  <main>
    <!-- 1) Quick Add (une publication) -->
    <section class="card">
      <h3>Ajouter une publication</h3>
      <div class="row">
        <div class="two">
          <div>
            <label>Plateforme</label>
            <select id="platform">
              <option>YouTube</option><option>TikTok</option><option>Instagram</option>
              <option>YouTube Shorts</option><option>IG Reels</option><option>Facebook</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label>Date & heure</label>
            <input id="datetime" type="datetime-local">
          </div>
        </div>
        <div style="width:100%">
          <label>Titre (optionnel)</label>
          <input id="title" placeholder="Ex: Vlog Tokyo #12" />
        </div>
        <div class="two">
          <button id="btnAdd">Enregistrer la publication</button>
          <button id="btnClearToday" class="btn-ghost">Supprimer les entrées du jour</button>
        </div>
      </div>
      <div class="mini">Astuce: si tu t’es trompé, va dans <b>Historique</b> pour modifier ou supprimer.</div>
    </section>

    <!-- 2) Objectif mensuel (séparé) -->
    <section class="card">
      <h3>Objectif mensuel</h3>
      <div class="two">
        <div>
          <label>Objectif (# posts / mois)</label>
          <input id="monthlyTarget" type="number" min="1" step="1" placeholder="Ex: 20">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnSaveTarget">Enregistrer l’objectif</button>
        </div>
      </div>
      <div class="mini">Le statut (vert/orange/rouge) se base sur cet objectif.</div>
    </section>

    <!-- 3) Ajout en lot -->
    <section class="card">
      <h3>“J’ai posté X” (ajout rapide)</h3>
      <div class="two">
        <div>
          <label>Date</label>
          <input id="bulkDate" type="date">
        </div>
        <div>
          <label>Combien ?</label>
          <input id="bulkCount" type="number" min="1" step="1" value="1">
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>Plateforme</label>
          <select id="bulkPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram</option>
            <option>YouTube Shorts</option><option>IG Reels</option><option>Facebook</option><option>Autre</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnAddBulk">Ajouter X publications</button>
        </div>
      </div>
      <div class="mini">Ajoute N entrées pour la date choisie (elles seront espacées d’1 min à partir de 12:00).</div>
    </section>

    <!-- 4) Progress -->
    <section class="card">
      <h3>Progression — <span id="monthLabel"></span></h3>
      <div class="two">
        <div>
          <canvas id="ringChart"></canvas>
          <div class="mini" id="ringText" style="text-align:center;margin-top:6px;"></div>
        </div>
        <div>
          <canvas id="monthBar"></canvas>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Année <span id="yearLabel"></span></h3>
      <canvas id="yearBar"></canvas>
    </section>

    <!-- 5) Insights -->
    <section class="card">
      <h3>Vos insights</h3>
      <div class="insight"><div>Dernière publication</div><div id="lastPost">—</div></div>
      <div class="insight"><div>Streak (jours consécutifs)</div><div id="streak">0</div></div>
      <div class="insight"><div>À faire pour l’objectif</div><div id="toGoal">—</div></div>
      <div class="insight"><div>Meilleurs créneaux</div><div id="bestSlots">—</div></div>
      <div class="insight"><div>Conseil</div><div id="advice">—</div></div>
    </section>

    <!-- 6) Notifications -->
    <section class="card">
      <h3>Rappels & notifications</h3>
      <div class="row">
        <button id="btnNotif">Autoriser les notifications</button>
        <span class="mini" id="notifState">Permission inconnue</span>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>Heure quotidienne</label>
          <input id="reminderTime" type="time" value="19:00">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnSaveReminder">Enregistrer le rappel</button>
        </div>
      </div>
      <div class="row" id="days" style="margin-top:6px"></div>
      <div class="mini">iOS: notifications locales quand l’app est ouverte / ajoutée à l’écran d’accueil.</div>
    </section>

    <!-- 7) Background Giphy -->
    <section class="card">
      <h3>Background (GIPHY)</h3>
      <div class="two">
        <div>
          <label>Rechercher un GIF</label>
          <input id="bgQuery" type="search" placeholder="Ex: ghibli food, neon city, waves…">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnBgSearch">Rechercher</button>
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>ID/URL Giphy</label>
          <input id="bgIdInput" placeholder="https://giphy.com/gifs/... ou ID">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnBgApply">Utiliser ID/URL</button>
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <button id="btnBgTrending" class="btn-ghost">Trending</button>
        <button id="btnBgReset" class="btn-ghost">Réinitialiser (Ghibli)</button>
      </div>
      <div id="bgResults" class="grid"></div>
    </section>

    <!-- 8) Historique (modifier / supprimer) -->
    <section class="card">
      <h3>Historique (modifier / supprimer)</h3>
      <div id="historyList" class="col" style="display:grid;gap:10px"></div>
      <div class="mini">Tu peux corriger une ligne (date, titre, plateforme) ou la supprimer.</div>
    </section>

    <!-- 9) Données -->
    <section class="card">
      <h3>Données</h3>
      <div class="two">
        <button id="btnExport" class="btn-ghost">Exporter JSON</button>
        <label class="btn-ghost" style="display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer">
          <input id="importFile" type="file" accept="application/json" style="display:none">
          Importer JSON
        </label>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" style="position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b0f14;border:1px solid var(--stroke);padding:12px 14px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.35);display:none;z-index:10"></div>

  <script>
  // ---------- CONFIG ----------
  const GIPHY_KEY = "uSWzkyG4P3SWLfM2cDpYEh5J4M4cIWB9";
  const DEFAULT_GIPHY_ID = "MwUPdnmcZOWCA";
  const LS_KEY = "postit_data_v1";

  // ---------- STATE ----------
  const state = {
    posts: [], // {id, ts, platform, title}
    settings: {
      monthlyTarget: 20,
      reminderTime: "19:00",
      reminderDays: [1,2,3,4,5],
      notifGranted: false,
      giphyId: null
    },
    charts: { ring:null, monthBar:null, yearBar:null }
  };

  // ---------- UTIL ----------
  const $ = sel => document.querySelector(sel);
  function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }
  function todayLocalISO(){ const now=new Date(); const off=now.getTimezoneOffset(); const local=new Date(now - off*60*1000); return local.toISOString().slice(0,16); }
  function todayLocalDate(){ const now=new Date(); const off=now.getTimezoneOffset(); const local=new Date(now - off*60*1000); return local.toISOString().slice(0,10); }
  function formatDate(d){ const dd=new Date(d); return isNaN(dd) ? "—" : dd.toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}); }
  function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,7)).toUpperCase(); }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify({posts:state.posts, settings:state.settings})); }
  function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const d=JSON.parse(raw); if(Array.isArray(d.posts)) state.posts=d.posts; if(d.settings) state.settings=Object.assign(state.settings,d.settings);}catch(e){} }

  // ---------- BG / GIPHY ----------
  async function setGiphyBackgroundById(id){
    try{
      const res = await fetch("https://api.giphy.com/v1/gifs/"+id+"?api_key="+GIPHY_KEY);
      const data = await res.json();
      const images = data?.data?.images;
      const mp4 = images?.original?.mp4 || images?.downsized_small?.mp4;
      const gif = images?.downsized_large?.url || images?.original?.url;
      const v = $("#bgVideo"); const img = $("#bgImage");
      if(mp4){
        img.style.display='none'; v.style.display='block'; v.src = mp4;
        const tryPlay = ()=> v.play().catch(()=>{});
        v.addEventListener('loadeddata', tryPlay, {once:true});
        document.addEventListener('touchstart', tryPlay, {once:true, passive:true});
      }else if(gif){
        v.pause(); v.removeAttribute('src'); v.load();
        img.src = gif; img.style.display='block';
      }
      state.settings.giphyId = data?.data?.id || id; save();
    }catch(e){ toast("Impossible de charger ce GIF"); }
  }
  function extractGiphyId(input){
    if(!input) return null;
    let m = input.match(/giphy\.com\/media\/([A-Za-z0-9]+)\b/i); if(m) return m[1];
    m = input.match(/giphy\.com\/gifs\/.+-([A-Za-z0-9]+)\b/i); if(m) return m[1];
    m = input.match(/^([A-Za-z0-9]+)$/); if(m) return m[1];
    return null;
  }
  async function searchGiphy(q, type){
    const endpoint = type==="trending"
      ? `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_KEY}&limit=12&rating=g`
      : `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(q)}&limit=12&rating=g`;
    try{
      const res = await fetch(endpoint); const json = await res.json(); const arr = json?.data || [];
      const wrap = $("#bgResults"); wrap.innerHTML = arr.length? "": "<div class='mini'>Aucun résultat</div>";
      arr.forEach(g=>{
        const still = g.images?.fixed_width_small_still?.url || g.images?.downsized_still?.url || g.images?.preview_gif?.url;
        const div = document.createElement("div"); div.className="thumb"; div.title = g.title || g.slug || g.id;
        const img = document.createElement("img"); img.src = still; div.appendChild(img);
        div.onclick = ()=> setGiphyBackgroundById(g.id);
        wrap.appendChild(div);
      });
    }catch(e){ toast("Recherche Giphy impossible"); }
  }

  // ---------- STATS ----------
  function isSameDay(a,b){ const da=new Date(a), db=new Date(b); return da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() && da.getDate()===db.getDate(); }
  function computeStats(){
    const now=new Date(), y=now.getFullYear(), m=now.getMonth(), last=new Date(y,m+1,0), daysInMonth=last.getDate();
    const daily=new Array(daysInMonth).fill(0), monthly=new Array(12).fill(0), wday=new Array(7).fill(0), hour=new Array(24).fill(0);
    let lastTs=null, streak=0;
    state.posts.forEach(p=>{
      const d=new Date(p.ts), yy=d.getFullYear(), mm=d.getMonth(), dd=d.getDate();
      monthly[mm]++; if(yy===y && mm===m) daily[dd-1]++; wday[d.getDay()]++; hour[d.getHours()]++; if(!lastTs || p.ts>lastTs) lastTs=p.ts;
    });
    // streak
    let cur=new Date(); cur.setHours(0,0,0,0);
    while(true){ const found=state.posts.some(p=>isSameDay(p.ts,cur.getTime())); if(found){ streak++; cur=new Date(cur.getTime()-86400000);} else break;}
    return {daily, monthly, daysInMonth, lastTs, streak, wday, hour};
  }
  function colorForProgress(p){ if(p>=1) return {cls:'', pill:'On track'}; if(p>=0.75) return {cls:'orange', pill:'Presque'}; return {cls:'red', pill:'En retard'}; }

  // ---------- RENDER ----------
  function renderInsights(stats){
    $("#lastPost").textContent = stats.lastTs ? formatDate(stats.lastTs) : "Pas encore";
    $("#streak").textContent = String(stats.streak);
    const monthTotal = stats.daily.reduce((a,b)=>a+b,0);
    const target = Number(state.settings.monthlyTarget || 20);
    const remain = Math.max(0, target - monthTotal);
    $("#toGoal").textContent = remain===0 ? "Objectif atteint ✅" : `${remain} post(s) restant(s) ce mois-ci`;

    const wNames = ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
    const topW = [...stats.wday?.map((v,i)=>({i,v}))||[]].sort((a,b)=>b.v-a.v).slice(0,2).map(o=>wNames[o.i]).join(", ");
    const topH = [...stats.hour?.map((v,i)=>({i,v}))||[]].sort((a,b)=>b.v-a.v).slice(0,2).map(o=>`${String(o.i).padStart(2,'0')}h`).join(", ");
    $("#bestSlots").textContent = (stats.wday && stats.wday.some(v=>v>0)) ? `${topW} @ ${topH}` : "Pas assez de données";

    const now=new Date();
    const remainMsg = (remain>0)
      ? `Il te reste ~${remain}. Vise ${Math.ceil(remain / Math.max(1, (new Date(now.getFullYear(), now.getMonth()+1, 0).getDate() - now.getDate()+1)/2 ))}/j pour rattraper.`
      : "Tu es large, prépare du contenu d'avance ✅";
    $("#advice").textContent = remainMsg;
  }

  function renderCharts(stats){
    // force canvas height for iOS
    ["ringChart","monthBar","yearBar"].forEach(id=>{ const c=$( "#"+id ); c.height = 240; });

    const monthTotal = stats.daily.reduce((a,b)=>a+b,0);
    const target = Number(state.settings.monthlyTarget || 20);
    const progress = Math.min(1, monthTotal / Math.max(1,target));
    const pill = $("#statusPill"), col = colorForProgress(progress);
    pill.className = "pill " + (col.cls || ""); $("#pillText").textContent = col.pill;

    if(state.charts.ring) state.charts.ring.destroy();
    state.charts.ring = new Chart($("#ringChart"), {
      type:'doughnut',
      data:{ labels:["Fait","Reste"], datasets:[{ data:[monthTotal, Math.max(0,target-monthTotal)], borderWidth:0, hoverOffset:2, cutout:"68%", backgroundColor:[ progress>=1 ? "#19e28a" : (progress>=0.75 ? "#ffb020" : "#ff4d6d"), "rgba(255,255,255,0.08)" ]}]},
      options:{ plugins:{legend:{display:false}, tooltip:{enabled:true}}, responsive:true, animation:{duration:400} }
    });

    const d=new Date(), labelsM = Array.from({length: stats.daysInMonth}, (_,i)=> String(i+1));
    if(state.charts.monthBar) state.charts.monthBar.destroy();
    state.charts.monthBar = new Chart($("#monthBar"), {
      type:'bar',
      data:{ labels:labelsM, datasets:[{ label:`${d.toLocaleString('fr-FR',{month:'long'})} ${d.getFullYear()}`, data:stats.daily, backgroundColor: labelsM.map(()=> "rgba(124,243,255,0.35)") }]},
      options:{ scales:{ x:{grid:{display:false},ticks:{maxRotation:0,minRotation:0,autoSkip:true,maxTicksLimit:7}}, y:{beginAtZero:true,grid:{color:"rgba(255,255,255,0.06)"}} }, plugins:{legend:{display:false}} }
    });

    const labelsY=["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Aoû","Sep","Oct","Nov","Déc"];
    if(state.charts.yearBar) state.charts.yearBar.destroy();
    state.charts.yearBar = new Chart($("#yearBar"), {
      type:'bar',
      data:{ labels:labelsY, datasets:[{ label:`Publications ${d.getFullYear()}`, data:stats.monthly, backgroundColor: labelsY.map(()=> "rgba(124,243,255,0.35)") }]},
      options:{ scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,grid:{color:"rgba(255,255,255,0.06)"}} }, plugins:{legend:{display:false}} }
    });

    $("#monthLabel").textContent = d.toLocaleString('fr-FR',{month:'long', year:'numeric'});
    $("#yearLabel").textContent = d.getFullYear();
  }

  function renderHistory(){
    const wrap = $("#historyList");
    const items = [...state.posts].sort((a,b)=>b.ts-a.ts).slice(0,100);
    if(items.length===0){ wrap.innerHTML = "<div class='mini'>Aucune publication enregistrée.</div>"; return; }
    wrap.innerHTML = items.map(p=>{
      return `
      <div class="item" data-id="${p.id}">
        <div class="item-row">
          <div class="meta"><b>${formatDate(p.ts)}</b> — ${p.platform}${p.title? " — "+escapeHtml(p.title):""}</div>
          <div class="actions">
            <button data-action="edit">✏️ Modifier</button>
            <button data-action="delete" class="btn-ghost">🗑️ Supprimer</button>
          </div>
        </div>
        <div class="edit">
          <div class="two">
            <div>
              <label>Date & heure</label>
              <input type="datetime-local" data-field="dt" value="${toLocalInputValue(p.ts)}">
            </div>
            <div>
              <label>Plateforme</label>
              <select data-field="platform">
                ${["YouTube","TikTok","Instagram","YouTube Shorts","IG Reels","Facebook","Autre"].map(opt=>`<option ${opt===p.platform?"selected":""}>${opt}</option>`).join("")}
              </select>
            </div>
          </div>
          <div style="margin-top:8px">
            <label>Titre</label>
            <input data-field="title" value="${escapeHtml(p.title||"")}" placeholder="Titre (optionnel)">
          </div>
          <div class="two" style="margin-top:8px">
            <button data-action="save">💾 Enregistrer</button>
            <button data-action="cancel" class="btn-ghost">Annuler</button>
          </div>
        </div>
      </div>`;
    }).join("");
  }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  function toLocalInputValue(ts){
    const d=new Date(ts); const off=d.getTimezoneOffset(); const local=new Date(d - off*60*1000);
    return local.toISOString().slice(0,16);
  }

  // ---------- NOTIFS ----------
  function renderDaysPicker(){
    const wrap=$("#days"); wrap.innerHTML="";
    ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"].forEach((n,i)=>{
      const b=document.createElement("button"); b.type="button"; b.className="day"+(state.settings.reminderDays.includes(i)?" active":""); b.textContent=n;
      b.onclick=()=>{ const idx=state.settings.reminderDays.indexOf(i); if(idx>=0) state.settings.reminderDays.splice(idx,1); else state.settings.reminderDays.push(i); save(); renderDaysPicker(); };
      wrap.appendChild(b);
    });
  }
  function notifStatus(){ const perm = (window.Notification && Notification.permission) ? Notification.permission : "denied"; $("#notifState").textContent = "Permission: " + perm; }
  function scheduleTicker(){
    setInterval(()=>{
      const now=new Date(); const hh=String(now.getHours()).padStart(2,"0"), mm=String(now.getMinutes()).padStart(2,"0");
      const hitTime = `${hh}:${mm}` === (state.settings.reminderTime||"19:00");
      const hitDay = state.settings.reminderDays.includes(now.getDay());
      const key="postit_last_notif_day", todayKey=now.toISOString().slice(0,10), last=localStorage.getItem(key);
      if(hitTime && hitDay && last!==todayKey){
        if(window.Notification && Notification.permission==="granted"){ new Notification("POSTIT 🔔", { body:"Pense à poster aujourd’hui 💪" }); }
        toast("Rappel: poste aujourd’hui !");
        localStorage.setItem(key,todayKey);
      }
    }, 60000);
  }

  // ---------- UI BIND ----------
  function bindUI(){
    $("#datetime").value = todayLocalISO();
    $("#bulkDate").value = todayLocalDate();
    $("#monthlyTarget").value = state.settings.monthlyTarget || 20;
    $("#reminderTime").value = state.settings.reminderTime || "19:00";
    notifStatus(); renderDaysPicker();

    // Notifs
    $("#btnNotif").onclick = async ()=>{
      if(!("Notification" in window)){ toast("Notifications non supportées"); return; }
      const perm = await Notification.requestPermission(); state.settings.notifGranted = (perm==="granted"); save(); notifStatus();
      toast(perm==="granted" ? "Notifications autorisées ✅" : "Notifications refusées");
    };
    $("#btnSaveReminder").onclick = ()=>{ state.settings.reminderTime = $("#reminderTime").value || "19:00"; save(); toast("Rappel enregistré"); };

    // Objectif (séparé)
    $("#btnSaveTarget").onclick = ()=>{
      const tgt = Number($("#monthlyTarget").value);
      if(!tgt || tgt<1){ toast("Objectif invalide"); return; }
      state.settings.monthlyTarget = tgt; save();
      const s=computeStats(); renderCharts(s); renderInsights(s);
      toast("Objectif enregistré ✅");
    };

    // Ajout unitaire
    $("#btnAdd").onclick = ()=>{
      const platform = $("#platform").value.trim(), dt=$("#datetime").value, title=$("#title").value.trim();
      const ts = new Date(dt).getTime(); if(!ts || isNaN(ts)){ toast("Date invalide"); return; }
      state.posts.push({id:uid(), ts, platform, title}); state.posts.sort((a,b)=>a.ts-b.ts);
      save(); $("#title").value=""; $("#datetime").value = todayLocalISO(); toast("Publication enregistrée ✅");
      const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
    };

    // Supprimer toutes les entrées du jour (utile si erreur)
    $("#btnClearToday").onclick = ()=>{
      const today = new Date(); today.setHours(0,0,0,0);
      const before = state.posts.length;
      state.posts = state.posts.filter(p => !isSameDay(p.ts, today.getTime()));
      if(state.posts.length===before){ toast("Aucune entrée aujourd’hui"); return; }
      save(); const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
      toast("Entrées du jour supprimées");
    };

    // Ajout en lot
    $("#btnAddBulk").onclick = ()=>{
      const d = $("#bulkDate").value; const n = Number($("#bulkCount").value||1);
      const platform = $("#bulkPlatform").value.trim();
      if(!d || !n || n<1){ toast("Remplis la date et le nombre"); return; }
      const base = new Date(d+"T12:00"); // midi
      for(let i=0;i<n;i++){ state.posts.push({id:uid(), ts: base.getTime()+i*60000, platform, title:""}); }
      state.posts.sort((a,b)=>a.ts-b.ts); save();
      const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
      toast(`Ajouté ${n} publication(s) ✅`);
    };

    // Historique : actions (délégation)
    $("#historyList").onclick = (e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const item = e.target.closest(".item"); const id = item.dataset.id;
      const idx = state.posts.findIndex(p=>p.id===id); if(idx<0) return;

      if(btn.dataset.action==="delete"){
        if(confirm("Supprimer cette publication ?")){
          state.posts.splice(idx,1); save();
          const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
          toast("Supprimé ✅");
        }
      }
      if(btn.dataset.action==="edit"){
        item.querySelector(".edit").style.display="grid";
        item.querySelector(".item-row").style.display="none";
      }
      if(btn.dataset.action==="cancel"){
        item.querySelector(".edit").style.display="none";
        item.querySelector(".item-row").style.display="";
      }
      if(btn.dataset.action==="save"){
        const dt = item.querySelector('[data-field="dt"]').value;
        const platform = item.querySelector('[data-field="platform"]').value.trim();
        const title = item.querySelector('[data-field="title"]').value;
        const ts = new Date(dt).getTime(); if(!ts||isNaN(ts)){ toast("Date invalide"); return; }
        state.posts[idx].ts = ts; state.posts[idx].platform = platform; state.posts[idx].title = title;
        state.posts.sort((a,b)=>a.ts-b.ts); save();
        const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
        toast("Modifié ✅");
      }
    };

    // GIPHY controls
    $("#btnBgSearch").onclick = ()=>{ const q=$("#bgQuery").value.trim(); if(!q){ toast("Entre un mot-clé"); return; } searchGiphy(q,"search"); };
    $("#btnBgTrending").onclick = ()=> searchGiphy("", "trending");
    $("#btnBgReset").onclick = ()=> setGiphyBackgroundById(DEFAULT_GIPHY_ID);
    $("#btnBgApply").onclick = ()=>{ const val=$("#bgIdInput").value.trim(); const id=extractGiphyId(val); if(!id){ toast("ID/URL invalide"); return; } setGiphyBackgroundById(id); };
  }

  // ---------- INIT ----------
  async function init(){
    load();
    await setGiphyBackgroundById(state.settings.giphyId || DEFAULT_GIPHY_ID);
    bindUI();
    const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
    scheduleTicker();
    // iOS orientation: re-render
    window.addEventListener('resize', ()=>{ const s=computeStats(); renderCharts(s); }, {passive:true});
  }
  window.addEventListener('load', init);
  </script>
</body>
</html>
