<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>POSTIT — Tracker de publications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='512' height='512' fill='%23000'/><text x='50%' y='56%' font-size='260' text-anchor='middle' fill='%23fff' font-family='Arial'>P</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --card: rgba(15,15,20,0.55);
      --stroke: rgba(255,255,255,0.08);
      --txt: #f4f6fb;
      --muted:#aab3c0;
      --green:#19e28a; --orange:#ffb020; --red:#ff4d6d;
      --radius:20px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Roboto,Arial,sans-serif;background:#05060a;}

    /* BACKGROUND — ne capte pas les touches */
    #bgWrap{position:fixed;inset:0;z-index:-3;overflow:hidden;pointer-events:none;}
    #bgVideo,#bgImage{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(0.56) saturate(1.2);}
    /* verre adouci (plus de “grosse ligne”) */
    #glass{position:fixed;inset:0;z-index:-2;pointer-events:none;
      background:
        radial-gradient(1200px 800px at 100% 0%, rgba(124,243,255,0.12), transparent 62%),
        linear-gradient(to bottom, rgba(0,0,0,0.38), rgba(0,0,0,0.68));
      backdrop-filter: blur(12px);
    }

    header{position:sticky;top:0;z-index:4;
      padding:max(12px,env(safe-area-inset-top)) 14px 10px;
      display:flex;align-items:center;gap:10px;
      background:linear-gradient(to bottom, rgba(5,6,10,0.7), rgba(5,6,10,0));
      border-bottom:none; /* pas de ligne */
      backdrop-filter: blur(8px);
    }
    .brand{font-weight:800;letter-spacing:.5px;font-size:20px;}
    .pill{margin-left:auto;display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--card)}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--green)}
    .pill.red .dot{background:var(--red)} .pill.orange .dot{background:var(--orange)}

    main{position:relative;z-index:1;isolation:isolate;
      padding:16px;padding-bottom:calc(24px + env(safe-area-inset-bottom));
      display:grid;gap:14px;max-width:760px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 10px;font-size:16px;font-weight:700}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input,select,button{
      width:100%;padding:14px 12px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);color:var(--txt);font-size:15px;outline:none;
      touch-action:manipulation; /* iOS: pas de délai */
    }
    button{font-weight:700;letter-spacing:.3px;background:linear-gradient(135deg,#00e1ff33,#00ffa033);border-color:#00e1ff55;cursor:pointer;user-select:none}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border-color:var(--stroke)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    canvas{width:100%;height:260px;display:block}
    .mini{font-size:12px;color:var(--muted)}
    .insight{display:flex;justify-content:space-between;gap:8px;padding:10px 0;border-top:1px dashed var(--stroke)}
    .insight:first-child{border-top:0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--stroke);aspect-ratio:1/1;background:rgba(255,255,255,.06);cursor:pointer;touch-action:manipulation}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .item{display:grid;gap:8px;padding:10px;border:1px solid var(--stroke);border-radius:14px;background:rgba(255,255,255,.04)}
    .item-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .edit{display:none;gap:8px}
    .edit .two{grid-template-columns:1fr 1fr}
    @media(min-width:720px){ canvas{height:220px} }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
  </style>
</head>
<body>
  <div id="bgWrap">
    <video id="bgVideo" autoplay muted playsinline loop></video>
    <img id="bgImage" alt="" style="display:none"/>
  </div>
  <div id="glass"></div>

  <header>
    <div class="brand">POSTIT</div>
    <div id="statusPill" class="pill"><span class="dot"></span><span id="pillText">On track</span></div>
  </header>

  <main>
    <!-- 1) Quick Add -->
    <section class="card">
      <h3>Ajouter une publication</h3>
      <div class="row">
        <div class="two">
          <div>
            <label>Plateforme</label>
            <select id="platform">
              <option>YouTube</option><option>TikTok</option><option>Instagram</option>
              <option>YouTube Shorts</option><option>IG Reels</option><option>Facebook</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label>Date & heure</label>
            <input id="datetime" type="datetime-local">
          </div>
        </div>
        <div style="width:100%">
          <label>Titre (optionnel)</label>
          <input id="title" placeholder="Ex: Vlog Tokyo #12" />
        </div>
        <div class="two">
          <button type="button" id="btnAdd">Enregistrer la publication</button>
          <button type="button" id="btnClearToday" class="btn-ghost">Supprimer les entrées du jour</button>
        </div>
      </div>
      <div class="mini">Astuce: corrige dans <b>Historique</b> si tu t’es trompé.</div>
    </section>

    <!-- 2) Objectif -->
    <section class="card">
      <h3>Objectif mensuel</h3>
      <div class="two">
        <div>
          <label>Objectif (# posts / mois)</label>
          <input id="monthlyTarget" type="number" min="1" step="1" placeholder="Ex: 20">
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnSaveTarget">Enregistrer l’objectif</button>
        </div>
      </div>
    </section>

    <!-- 3) Ajout en lot -->
    <section class="card">
      <h3>“J’ai posté X” (ajout rapide)</h3>
      <div class="two">
        <div>
          <label>Date</label>
          <input id="bulkDate" type="date">
        </div>
        <div>
          <label>Combien ?</label>
          <input id="bulkCount" type="number" min="1" step="1" value="1">
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>Plateforme</label>
          <select id="bulkPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram</option>
            <option>YouTube Shorts</option><option>IG Reels</option><option>Facebook</option><option>Autre</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnAddBulk">Ajouter X publications</button>
        </div>
      </div>
      <div class="mini">Ajoute N entrées pour la date (espacées d’1 min à partir de 12:00).</div>
    </section>

    <!-- 4) Progress -->
    <section class="card">
      <h3>Progression — <span id="monthLabel"></span></h3>
      <div class="two">
        <div>
          <canvas id="ringChart"></canvas>
          <div class="mini" id="ringText" style="text-align:center;margin-top:6px;"></div>
        </div>
        <div>
          <canvas id="monthBar"></canvas>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Année <span id="yearLabel"></span></h3>
      <canvas id="yearBar"></canvas>
    </section>

    <!-- 5) Insights -->
    <section class="card">
      <h3>Vos insights</h3>
      <div class="insight"><div>Dernière publication</div><div id="lastPost">—</div></div>
      <div class="insight"><div>Streak (jours consécutifs)</div><div id="streak">0</div></div>
      <div class="insight"><div>À faire pour l’objectif</div><div id="toGoal">—</div></div>
      <div class="insight"><div>Meilleurs créneaux</div><div id="bestSlots">—</div></div>
      <div class="insight"><div>Conseil</div><div id="advice">—</div></div>
    </section>

    <!-- 6) Notifications -->
    <section class="card">
      <h3>Rappels & notifications</h3>
      <div class="row">
        <button type="button" id="btnNotif">Autoriser les notifications</button>
        <span class="mini" id="notifState">Permission inconnue</span>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>Heure quotidienne</label>
          <input id="reminderTime" type="time" value="19:00">
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnSaveReminder">Enregistrer le rappel</button>
        </div>
      </div>
      <div class="row" id="days" style="margin-top:6px"></div>
      <div class="mini">iOS: notifications locales quand l’app est ouverte / ajoutée à l’écran d’accueil.</div>
    </section>

    <!-- 7) Background Giphy -->
    <section class="card">
      <h3>Background (GIPHY)</h3>
      <div class="two">
        <div>
          <label>Rechercher un GIF</label>
          <input id="bgQuery" type="search" placeholder="Ex: ghibli food, neon city, waves…">
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnBgSearch">Rechercher</button>
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <div>
          <label>ID/URL Giphy</label>
          <input id="bgIdInput" placeholder="https://giphy.com/gifs/... ou ID">
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnBgApply">Utiliser ID/URL</button>
        </div>
      </div>
      <div class="two" style="margin-top:8px">
        <button type="button" id="btnBgTrending" class="btn-ghost">Trending</button>
        <button type="button" id="btnBgReset" class="btn-ghost">Réinitialiser (Ghibli)</button>
      </div>
      <div id="bgResults" class="grid"></div>
    </section>

    <!-- 8) Historique -->
    <section class="card">
      <h3>Historique (modifier / supprimer)</h3>
      <div id="historyList" class="col" style="display:grid;gap:10px"></div>
      <div class="mini">Corrige une ligne (date, titre, plateforme) ou supprime-la.</div>
    </section>

    <!-- 9) Données -->
    <section class="card">
      <h3>Données</h3>
      <div class="two">
        <button type="button" id="btnExport" class="btn-ghost">Exporter JSON</button>
        <label class="btn-ghost" style="display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer">
          <input id="importFile" type="file" accept="application/json" style="display:none">
          Importer JSON
        </label>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" style="position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b0f14;border:1px solid var(--stroke);padding:12px 14px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.35);display:none;z-index:10"></div>

  <script>
  /* ========== CONFIG ========= */
  const GIPHY_KEY = "uSWzkyG4P3SWLfM2cDpYEh5J4M4cIWB9";
  const DEFAULT_GIPHY_ID = "MwUPdnmcZOWCA";
  const LS_KEY = "postit_data_v1";

  /* ========== STATE ========= */
  const state = {
    posts: [], // {id, ts, platform, title}
    settings: {
      monthlyTarget: 20,
      reminderTime: "19:00",
      reminderDays: [1,2,3,4,5],
      notifGranted: false,
      giphyId: null
    },
    charts: { ring:null, monthBar:null, yearBar:null }
  };

  /* ========== UTIL ========= */
  const $ = sel => document.querySelector(sel);
  function onTap(el, handler){
    if(typeof el === 'string') el = $(el);
    if(!el) return;
    let fired = false;
    const fn = e => { if(fired) return; fired=true; e.preventDefault(); handler(e); setTimeout(()=>fired=false,50); };
    el.addEventListener('click', fn, {passive:false});
    el.addEventListener('touchend', fn, {passive:false});
    el.addEventListener('pointerup', fn, {passive:false});
  }
  function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }
  function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,7)).toUpperCase(); }
  function todayLocalISO(){ const now=new Date(); const off=now.getTimezoneOffset(); const local=new Date(now - off*60*1000); return local.toISOString().slice(0,16); }
  function todayLocalDate(){ const now=new Date(); const off=now.getTimezoneOffset(); const local=new Date(now - off*60*1000); return local.toISOString().slice(0,10); }
  function formatDate(d){ const dd=new Date(d); return isNaN(dd) ? "—" : dd.toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}); }
  function toLocalInputValue(ts){ const d=new Date(ts); const off=d.getTimezoneOffset(); const local=new Date(d - off*60*1000); return local.toISOString().slice(0,16); }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify({posts:state.posts, settings:state.settings})); }
  function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const d=JSON.parse(raw); if(Array.isArray(d.posts)) state.posts=d.posts; if(d.settings) state.settings=Object.assign(state.settings,d.settings);}catch(e){} }

  /* ========== BG / GIPHY ========= */
  async function setGiphyBackgroundById(id){
    try{
      const res = await fetch("https://api.giphy.com/v1/gifs/"+id+"?api_key="+GIPHY_KEY);
      const data = await res.json();
      const images = data && data.data ? data.data.images : null;
      const mp4 = images && images.original && images.original.mp4 ? images.original.mp4 :
                  images && images.downsized_small && images.downsized_small.mp4 ? images.downsized_small.mp4 : null;
      const gif = images && images.downsized_large && images.downsized_large.url ? images.downsized_large.url :
                  images && images.original && images.original.url ? images.original.url : null;

      const v = $("#bgVideo"); const img = $("#bgImage");
      if(mp4){
        img.style.display='none'; v.style.display='block'; v.src = mp4;
        const tryPlay = ()=> v.play().catch(()=>{});
        v.addEventListener('loadeddata', tryPlay, {once:true});
        document.addEventListener('touchstart', tryPlay, {once:true, passive:true});
        document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); });
      }else if(gif){
        v.pause(); v.removeAttribute('src'); v.load();
        img.src = gif; img.style.display='block';
      }
      state.settings.giphyId = data && data.data ? data.data.id : id; save();
    }catch(e){ toast("Impossible de charger ce GIF"); }
  }
  function extractGiphyId(input){
    if(!input) return null;
    var m = input.match(/giphy\.com\/media\/([A-Za-z0-9]+)\b/i); if(m) return m[1];
    m = input.match(/giphy\.com\/gifs\/.+-([A-Za-z0-9]+)\b/i); if(m) return m[1];
    m = input.match(/^([A-Za-z0-9]+)$/); if(m) return m[1];
    return null;
  }
  async function searchGiphy(q, type){
    const endpoint = type==="trending"
      ? "https://api.giphy.com/v1/gifs/trending?api_key="+GIPHY_KEY+"&limit=12&rating=g"
      : "https://api.giphy.com/v1/gifs/search?api_key="+GIPHY_KEY+"&q="+encodeURIComponent(q)+"&limit=12&rating=g";
    try{
      const res = await fetch(endpoint); const json = await res.json(); const arr = json && json.data ? json.data : [];
      const wrap = $("#bgResults"); wrap.innerHTML = arr.length? "": "<div class='mini'>Aucun résultat</div>";
      for(var i=0;i<arr.length;i++){
        var g = arr[i];
        var still = g.images && (g.images.fixed_width_small_still && g.images.fixed_width_small_still.url ||
                                 g.images.downsized_still && g.images.downsized_still.url ||
                                 g.images.preview_gif && g.images.preview_gif.url) || "";
        var div = document.createElement("div"); div.className="thumb"; div.title = g.title || g.slug || g.id;
        var img = document.createElement("img"); img.src = still; div.appendChild(img);
        onTap(div, function(id){ return function(){ setGiphyBackgroundById(id); }; }(g.id));
        wrap.appendChild(div);
      }
    }catch(e){ toast("Recherche Giphy impossible"); }
  }

  /* ========== STATS ========= */
  function isSameDay(a,b){ const da=new Date(a), db=new Date(b); return da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() && da.getDate()===db.getDate(); }
  function computeStats(){
    const now=new Date(), y=now.getFullYear(), m=now.getMonth(), last=new Date(y,m+1,0), daysInMonth=last.getDate();
    const daily=new Array(daysInMonth).fill(0), monthly=new Array(12).fill(0), wday=new Array(7).fill(0), hour=new Array(24).fill(0);
    let lastTs=null, streak=0;
    for(var i=0;i<state.posts.length;i++){
      const p=state.posts[i]; const d=new Date(p.ts), yy=d.getFullYear(), mm=d.getMonth(), dd=d.getDate();
      monthly[mm]++; if(yy===y && mm===m) daily[dd-1]++; wday[d.getDay()]++; hour[d.getHours()]++; if(!lastTs || p.ts>lastTs) lastTs=p.ts;
    }
    let cur=new Date(); cur.setHours(0,0,0,0);
    while(true){ var found=false; for(i=0;i<state.posts.length;i++){ if(isSameDay(state.posts[i].ts,cur.getTime())){found=true;break;} } if(found){ streak++; cur=new Date(cur.getTime()-86400000);} else break;}
    return {daily:daily, monthly:monthly, daysInMonth:daysInMonth, lastTs:lastTs, streak:streak, wday:wday, hour:hour};
  }
  function colorForProgress(p){ if(p>=1) return {cls:'', pill:'On track'}; if(p>=0.75) return {cls:'orange', pill:'Presque'}; return {cls:'red', pill:'En retard'}; }

  /* ========== RENDER ========= */
  function renderInsights(stats){
    $("#lastPost").textContent = stats.lastTs ? formatDate(stats.lastTs) : "Pas encore";
    $("#streak").textContent = String(stats.streak);
    const monthTotal = stats.daily.reduce(function(a,b){return a+b;},0);
    const target = Number(state.settings.monthlyTarget || 20);
    const remain = Math.max(0, target - monthTotal);
    $("#toGoal").textContent = remain===0 ? "Objectif atteint ✅" : (remain+" post(s) restant(s) ce mois-ci");

    const wNames = ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
    var pairsW=[]; for(var i=0;i<stats.wday.length;i++) pairsW.push({i:i,v:stats.wday[i]});
    var pairsH=[]; for(i=0;i<stats.hour.length;i++) pairsH.push({i:i,v:stats.hour[i]});
    pairsW.sort(function(a,b){return b.v-a.v}); pairsH.sort(function(a,b){return b.v-a.v});
    const topW = pairsW.slice(0,2).map(function(o){return wNames[o.i];}).join(", ");
    const topH = pairsH.slice(0,2).map(function(o){return String(o.i).padStart(2,'0')+"h";}).join(", ");
    $("#bestSlots").textContent = (stats.wday.some(function(v){return v>0;})) ? (topW+" @ "+topH) : "Pas assez de données";

    const now=new Date();
    const remainMsg = (remain>0)? ("Il te reste ~"+remain+". Vise "+Math.ceil(remain / Math.max(1, (new Date(now.getFullYear(), now.getMonth()+1, 0).getDate() - now.getDate()+1)/2 ))+"/j pour rattraper.") : "Tu es large, prépare du contenu d'avance ✅";
    $("#advice").textContent = remainMsg;
  }
  function renderCharts(stats){
    ["ringChart","monthBar","yearBar"].forEach(function(id){ var c=document.getElementById(id); c.height = 240; });
    const monthTotal = stats.daily.reduce(function(a,b){return a+b;},0);
    const target = Number(state.settings.monthlyTarget || 20);
    const progress = Math.min(1, monthTotal / Math.max(1,target));
    const pill = $("#statusPill"), col = colorForProgress(progress);
    pill.className = "pill " + (col.cls || ""); $("#pillText").textContent = col.pill;

    if(state.charts.ring) state.charts.ring.destroy();
    state.charts.ring = new Chart($("#ringChart"), {
      type:'doughnut',
      data:{ labels:["Fait","Reste"], datasets:[{ data:[monthTotal, Math.max(0,target-monthTotal)], borderWidth:0, hoverOffset:2, cutout:"68%", backgroundColor:[ progress>=1 ? "#19e28a" : (progress>=0.75 ? "#ffb020" : "#ff4d6d"), "rgba(255,255,255,0.08)" ]}]},
      options:{ plugins:{legend:{display:false}, tooltip:{enabled:true}}, responsive:true, animation:{duration:400} }
    });

    const d=new Date(), labelsM = Array.from({length: stats.daysInMonth}, function(_,i){return String(i+1);});
    if(state.charts.monthBar) state.charts.monthBar.destroy();
    state.charts.monthBar = new Chart($("#monthBar"), {
      type:'bar',
      data:{ labels:labelsM, datasets:[{ label:(d.toLocaleString('fr-FR',{month:'long'})+" "+d.getFullYear()), data:stats.daily, backgroundColor: labelsM.map(function(){return "rgba(124,243,255,0.35)";}) }]},
      options:{ scales:{ x:{grid:{display:false},ticks:{maxRotation:0,minRotation:0,autoSkip:true,maxTicksLimit:7}}, y:{beginAtZero:true,grid:{color:"rgba(255,255,255,0.06)"}} }, plugins:{legend:{display:false}} }
    });

    const labelsY=["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Aoû","Sep","Oct","Nov","Déc"];
    if(state.charts.yearBar) state.charts.yearBar.destroy();
    state.charts.yearBar = new Chart($("#yearBar"), {
      type:'bar',
      data:{ labels:labelsY, datasets:[{ label:("Publications "+d.getFullYear()), data:stats.monthly, backgroundColor: labelsY.map(function(){return "rgba(124,243,255,0.35)";}) }]},
      options:{ scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,grid:{color:"rgba(255,255,255,0.06)"}} }, plugins:{legend:{display:false}} }
    });

    $("#monthLabel").textContent = d.toLocaleString('fr-FR',{month:'long', year:'numeric'});
    $("#yearLabel").textContent = d.getFullYear();
  }

  /* ===== HISTORIQUE (avec handlers tactiles) ===== */
  function renderHistory(){
    const wrap = document.querySelector("#historyList");
    const items = [].concat(state.posts).sort(function(a,b){return b.ts-a.ts;}).slice(0,100);
    if(items.length===0){ wrap.innerHTML = "<div class='mini'>Aucune publication enregistrée.</div>"; return; }

    wrap.innerHTML = items.map(function(p){
      return (
        '<div class="item" data-id="'+p.id+'">'+
          '<div class="item-row">'+
            '<div class="meta"><b>'+formatDate(p.ts)+'</b> — '+p.platform+(p.title? ' — '+escapeHtml(p.title):'')+'</div>'+
            '<div class="actions">'+
              '<button type="button" data-action="edit">✏️ Modifier</button>'+
              '<button type="button" data-action="delete" class="btn-ghost">🗑️ Supprimer</button>'+
            '</div>'+
          '</div>'+
          '<div class="edit">'+
            '<div class="two">'+
              '<div>'+
                '<label>Date & heure</label>'+
                '<input type="datetime-local" data-field="dt" value="'+toLocalInputValue(p.ts)+'">'+
              '</div>'+
              '<div>'+
                '<label>Plateforme</label>'+
                '<select data-field="platform">'+
                  ["YouTube","TikTok","Instagram","YouTube Shorts","IG Reels","Facebook","Autre"].map(function(opt){
                    return '<option '+(opt===p.platform?'selected':'')+'>'+opt+'</option>';
                  }).join("")+
                '</select>'+
              '</div>'+
            '</div>'+
            '<div style="margin-top:8px">'+
              '<label>Titre</label>'+
              '<input data-field="title" value="'+escapeHtml(p.title||"")+'" placeholder="Titre (optionnel)">'+
            '</div>'+
            '<div class="two" style="margin-top:8px">'+
              '<button type="button" data-action="save">💾 Enregistrer</button>'+
              '<button type="button" data-action="cancel" class="btn-ghost">Annuler</button>'+
            '</div>'+
          '</div>'+
        '</div>'
      );
    }).join("");

    attachHistoryHandlers();
  }

  function attachHistoryHandlers(){
    var root = document.querySelector("#historyList");
    var btns = root.querySelectorAll("[data-action]");
    for(var i=0;i<btns.length;i++){
      (function(btn){
        onTap(btn, function(e){
          e.preventDefault(); e.stopPropagation();
          handleHistoryAction(btn);
        });
      })(btns[i]);
    }
  }

  function handleHistoryAction(btn){
    var item = btn.closest ? btn.closest(".item") : btn.parentNode;
    while(item && (!item.classList || !item.classList.contains("item"))) item = item.parentNode;
    if(!item) return;

    var id = item.getAttribute("data-id");
    var idx = -1;
    for(var k=0;k<state.posts.length;k++){ if(state.posts[k].id===id){ idx=k; break; } }
    if(idx<0) return;

    var act = btn.getAttribute("data-action");
    if(act==="delete"){
      if(confirm("Supprimer cette publication ?")){
        state.posts.splice(idx,1); save();
        var s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
        toast("Supprimé ✅");
      }
      return;
    }
    if(act==="edit"){
      item.querySelector(".edit").style.display="grid";
      item.querySelector(".item-row").style.display="none";
      return;
    }
    if(act==="cancel"){
      item.querySelector(".edit").style.display="none";
      item.querySelector(".item-row").style.display="";
      return;
    }
    if(act==="save"){
      var dt = item.querySelector('[data-field="dt"]').value;
      var platform = item.querySelector('[data-field="platform"]').value;
      var title = item.querySelector('[data-field="title"]').value;
      var ts = new Date(dt).getTime(); if(!ts||isNaN(ts)){ toast("Date invalide"); return; }
      state.posts[idx].ts = ts; state.posts[idx].platform = platform; state.posts[idx].title = title;
      state.posts.sort(function(a,b){return a.ts-b.ts;}); save();
      var s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
      toast("Modifié ✅");
      return;
    }
  }

  /* ========== NOTIFS ========= */
  function renderDaysPicker(){
    const wrap=$("#days"); wrap.innerHTML="";
    ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"].forEach(function(n,i){
      const b=document.createElement("button"); b.type="button"; b.className="day"+(state.settings.reminderDays.includes(i)?" active":""); b.textContent=n; b.style.touchAction="manipulation";
      onTap(b, function(){ const idx=state.settings.reminderDays.indexOf(i); if(idx>=0) state.settings.reminderDays.splice(idx,1); else state.settings.reminderDays.push(i); save(); renderDaysPicker(); });
      wrap.appendChild(b);
    });
  }
  function notifStatus(){ const perm = (window.Notification && Notification.permission) ? Notification.permission : "denied"; $("#notifState").textContent = "Permission: " + perm; }
  function scheduleTicker(){
    setInterval(function(){
      const now=new Date(); const hh=String(now.getHours()).padStart(2,"0"), mm=String(now.getMinutes()).padStart(2,"0");
      const hitTime = (hh+":"+mm) === (state.settings.reminderTime||"19:00");
      const hitDay = state.settings.reminderDays.includes(now.getDay());
      const key="postit_last_notif_day", todayKey=now.toISOString().slice(0,10), last=localStorage.getItem(key);
      if(hitTime && hitDay && last!==todayKey){
        if(window.Notification && Notification.permission==="granted"){ new Notification("POSTIT 🔔", { body:"Pense à poster aujourd’hui 💪" }); }
        toast("Rappel: poste aujourd’hui !");
        localStorage.setItem(key,todayKey);
      }
    }, 60000);
  }

  /* ========== UI BIND ========= */
  function bindUI(){
    $("#datetime").value = todayLocalISO();
    $("#bulkDate").value = todayLocalDate();
    $("#monthlyTarget").value = state.settings.monthlyTarget || 20;
    $("#reminderTime").value = state.settings.reminderTime || "19:00";
    notifStatus(); renderDaysPicker();

    onTap("#btnNotif", async function(){
      if(!("Notification" in window)){ toast("Notifications non supportées"); return; }
      const perm = await Notification.requestPermission(); state.settings.notifGranted = (perm==="granted"); save(); notifStatus();
      toast(perm==="granted" ? "Notifications autorisées ✅" : "Notifications refusées");
    });
    onTap("#btnSaveReminder", function(){ state.settings.reminderTime = $("#reminderTime").value || "19:00"; save(); toast("Rappel enregistré"); });

    onTap("#btnSaveTarget", function(){
      const tgt = Number($("#monthlyTarget").value);
      if(!tgt || tgt<1){ toast("Objectif invalide"); return; }
      state.settings.monthlyTarget = tgt; save();
      const s=computeStats(); renderCharts(s); renderInsights(s);
      toast("Objectif enregistré ✅");
    });

    onTap("#btnAdd", function(){
      const platform = $("#platform").value.trim(), dt=$("#datetime").value, title=$("#title").value.trim();
      const ts = new Date(dt).getTime(); if(!ts || isNaN(ts)){ toast("Date invalide"); return; }
      state.posts.push({id:uid(), ts:ts, platform:platform, title:title}); state.posts.sort(function(a,b){return a.ts-b.ts;});
      save(); $("#title").value=""; $("#datetime").value = todayLocalISO(); toast("Publication enregistrée ✅");
      const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
    });

    onTap("#btnClearToday", function(){
      const today = new Date(); today.setHours(0,0,0,0);
      const before = state.posts.length;
      state.posts = state.posts.filter(function(p){ return !isSameDay(p.ts, today.getTime()); });
      if(state.posts.length===before){ toast("Aucune entrée aujourd’hui"); return; }
      save(); const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
      toast("Entrées du jour supprimées");
    });

    onTap("#btnAddBulk", function(){
      const d = $("#bulkDate").value; const n = Number($("#bulkCount").value||1);
      const platform = $("#bulkPlatform").value.trim();
      if(!d || !n || n<1){ toast("Remplis la date et le nombre"); return; }
      const base = new Date(d+"T12:00"); // midi
      for(let i=0;i<n;i++){ state.posts.push({id:uid(), ts: base.getTime()+i*60000, platform:platform, title:""}); }
      state.posts.sort(function(a,b){return a.ts-b.ts;}); save();
      const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
      toast("Ajouté "+n+" publication(s) ✅");
    });

    // GIPHY controls
    onTap("#btnBgSearch", function(){ const q=$("#bgQuery").value.trim(); if(!q){ toast("Entre un mot-clé"); return; } searchGiphy(q,"search"); });
    onTap("#btnBgTrending", function(){ searchGiphy("", "trending"); });
    onTap("#btnBgReset", function(){ setGiphyBackgroundById(DEFAULT_GIPHY_ID); });
    onTap("#btnBgApply", function(){ const val=$("#bgIdInput").value.trim(); const id=extractGiphyId(val); if(!id){ toast("ID/URL invalide"); return; } setGiphyBackgroundById(id); });
  }

  /* ========== INIT ========= */
  async function init(){
    load();
    await setGiphyBackgroundById(state.settings.giphyId || DEFAULT_GIPHY_ID);
    bindUI();
    const s=computeStats(); renderCharts(s); renderInsights(s); renderHistory();
    scheduleTicker();
    window.addEventListener('resize', function(){ const s=computeStats(); renderCharts(s); }, {passive:true});
  }
  window.addEventListener('load', init);
  </script>
</body>
</html>

